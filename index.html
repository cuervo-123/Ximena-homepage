<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi TV Station - Listados y Favoritos</title>
  <style>
    /* ====== presets de tama√±o del monitor ====== */
    :root { --player-max: 1280px; }
    .size-s { --player-max: 700px; }
    .size-m { --player-max: 960px; }
    .size-l { --player-max: 1280px; }
    .size-xl{ --player-max: 1600px; }

    @keyframes pulse {
      0%{transform:scale(1);opacity:.9}
      50%{transform:scale(1.05);opacity:1}
      100%{transform:scale(1);opacity:.9}
    }

    body{
      background:linear-gradient(135deg,#0f0f0f,#1a1a1a);
      color:#e0e0e0;
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0;
      display:flex;
      justify-content:center;
      padding-top:60px;
    }

    header{
      position:fixed;
      top:0;left:0;right:0;
      height:60px;
      background:#111826;
      border-bottom:1px solid #233044;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      z-index:1100;
    }

    .titulo-app{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:1.25rem;
      color:#00ffd5;
      font-weight:700;
      text-shadow:0 0 10px #00ffd5;
      margin:0;
    }

    .mano-animada{
      width:28px;height:28px;
      animation:moverManoIzq 1s infinite alternate;
      transform:scaleX(-1);
    }

    @keyframes moverManoIzq{
      0%{transform:scaleX(-1) translateX(0)}
      100%{transform:scaleX(-1) translateX(8px)}
    }

    #openMenuBtn{font-size:28px;cursor:pointer;color:#00ffd5}

    .container{
      max-width:1600px;
      width:100%;
      padding:20px;
      box-sizing:border-box;
      margin-top:60px;
    }

    /* ====== Men√∫ lateral ====== */
    #menuSlider{
      position:fixed;
      top:0;left:-250px;
      width:250px;height:100%;
      background:#191919;
      transition:left .3s ease-in-out;
      z-index:1000;
      padding:20px 15px;
      border-right:2px solid #00ffd5;
      box-shadow:4px 0 15px rgba(0,255,213,.2);
      overflow-y:auto;
    }
    #menuSlider.open{left:0;}

    .menu-item{
      display:inline-flex;
      color:#206d60;
      padding:12px 15px;
      font-size:18px;
      border-radius:8px;
      margin-bottom:10px;
      background:#2a2a2a;
      border:none;
      cursor:pointer;
      transition:background .3s;
    }
    .menu-item:hover{background:#00ffd5;color:#000;}

    .submenu{
      display:none;
      padding-left:15px;
      background:#1a1a1a;
      margin-bottom:15px;
      border-left:3px solid #00ffd5;
      border-radius:4px;
    }
    .submenu-button{
      font-size:15px;
      margin:8px 0;
      background:none;
      border:none;
      color:#aaa;
      cursor:pointer;
    }
    .submenu-button:hover{color:#00ffd5;}

    /* ====== Favoritos ====== */
    #favorites-slider{
      display:flex;
      overflow-x:auto;
      gap:15px;
      padding:10px;
      background:#1f1f1f;
      border-radius:12px;
      max-width:100%;
      box-shadow:inset 0 0 20px rgba(0,255,213,.05);
      justify-content:center;
    }
    .favorite-item{
      position:relative;
      min-width:180px;
      background:#2a2a2a;
      padding:10px;
      border-radius:12px;
      text-align:center;
      transition:transform .3s ease-in-out;
      box-shadow:0 4px 10px rgba(0,255,213,.2);
    }
    .favorite-item img{
      width:100%;
      height:auto;
      border-radius:10px;
      margin-bottom:5px;
      transition:opacity .3s;
    }
    .favorite-item:hover{transform:scale(1.1);}
    .favorite-item:hover img{opacity:.8;}
    .channel-name{
      font-size:16px;
      font-weight:700;
      color:#fff;
      margin-top:10px;
    }
    .hover-content{
      position:absolute;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,255,213,.08);
      display:flex;
      justify-content:center;
      align-items:center;
      opacity:0;
      transition:opacity .3s;
      border-radius:12px;
    }
    .favorite-item:hover .hover-content{opacity:1;}
    .hover-content button{
      padding:8px 12px;
      background:#00ffd5;
      border:none;
      color:#000;
      font-weight:700;
      cursor:pointer;
      border-radius:6px;
    }

    /* ====== MONITOR ====== */
    .player-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      margin:20px auto 0;
    }
    .player-media{
      width:min(100%,var(--player-max));
      aspect-ratio:16/9;
      height:auto;
      border-radius:12px;
      border:2px solid #00ffd5;
      background:#000;
      box-shadow:0 0 15px rgba(0,255,213,.3);
      display:block;
    }

    .favorite-star{
      font-size:30px;
      color:gold;
      cursor:pointer;
      margin-top:15px;
      text-align:center;
      display:block;
      text-shadow:0 0 10px gold;
    }

    input[type="file"],select,button{
      display:flex;
      margin:10px 5px;
      padding:10px;
      border-radius:6px;
      border:none;
      background:#333;
      color:#fff;
    }
    button:hover{background:#00ffd5;color:#000;}

    h3{text-align:center;margin-top:30px;color:#00ffd5;}

    #category-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .category-item{
      background:#2a2a2a;
      padding:10px;
      border-radius:8px;
    }

    /* ====== botones tama√±o ====== */
    .size-toolbar{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .size-btn{
      font-size:12px;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #233044;
      background:#1d2636;
      color:#cfe;
      cursor:pointer;
    }
    .size-btn.active{
      background:#00ffd5;
      color:#000;
      font-weight:700;
      border-color:#00ffd5;
    }

    /* ====== PANEL STICKY ====== */
    .sticky-panel{
      position:sticky;
      top:70px;
      z-index:900;
      margin-bottom:18px;
      border-radius:18px;
      padding:10px 14px 16px;
      background:linear-gradient(135deg,#020617,#020617ee);
      box-shadow:0 16px 30px rgba(0,0,0,.75);
      border:1px solid rgba(15,118,110,.7);
    }
    .sticky-panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sticky-panel-title{
      margin:0;
      color:#00ffd5;
      font-size:0.95rem;
      letter-spacing:.05em;
      text-transform:uppercase;
      opacity:.9;
    }
    .sticky-panel-sub{
      margin:0;
      font-size:0.78rem;
      color:#9ca3af;
    }
    #buscador{
      flex:1;
      padding:8px 10px;
      border-radius:999px;
      background:#111827;
      color:#00ffd5;
      border:1px solid #00ffd5;
      font-size:0.9rem;
    }

    /* ====== CARRUSEL (3 tarjetas) ====== */
    .carousel-hero{
      margin-top:6px;
      max-width:100%;
      background:radial-gradient(circle at top,#1f2937,#020617);
      border-radius:14px;
      padding:10px 10px 12px;
      box-shadow:0 0 18px rgba(0,255,213,.25);
    }
    .carousel-row{
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .carousel-card{
      flex:1 1 0;
      display:flex;
      flex-direction:column;
      background:rgba(15,23,42,.95);
      border-radius:12px;
      padding:8px;
      box-shadow:0 10px 18px rgba(0,0,0,.7);
      border:1px solid rgba(148,163,184,.5);
      overflow:hidden;
    }
    /* Contenedor de la car√°tula: mantiene proporci√≥n y centra la imagen */
.carousel-card-imgwrap{
  width:100%;
  aspect-ratio: 16 / 9;            /* marco estable tipo monitor */
  border-radius:9px;
  overflow:hidden;
  margin-bottom:6px;
  background:#000;                 /* fondo negro alrededor si sobra espacio */
  display:flex;
  align-items:center;
  justify-content:center;
}

/* Imagen con menos zoom y sin recortes */
.carousel-card-img{
  width:100%;
  height:100%;
  object-fit:contain;              /* üëâ muestra SIEMPRE la car√°tula completa */
  display:block;
}


    .carousel-tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:.06em;
      background:rgba(0,255,213,.08);
      border:1px solid rgba(0,255,213,.5);
      border-radius:999px;
      padding:2px 7px;
      color:#9fffea;
      margin-bottom:3px;
    }
    .carousel-title{
      margin:0 0 2px;
      font-size:0.9rem;
      color:#e8fdf9;
      text-shadow:0 0 6px rgba(0,255,213,.45);
    }
    .carousel-meta{
      margin:0 0 4px;
      font-size:0.76rem;
      color:#b7c4d7;
    }
    .carousel-actions{
      margin-top:auto;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .carousel-btn{
      border:none;
      border-radius:999px;
      padding:4px 9px;
      font-size:0.75rem;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .carousel-btn.primary{
      background:#00ffd5;
      color:#021018;
      box-shadow:0 0 12px rgba(0,255,213,.6);
    }
    .carousel-btn.secondary{
      background:rgba(15,23,42,.9);
      color:#e2f3ff;
      border:1px solid rgba(148,163,184,.6);
    }
    .carousel-controls{
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:0.8rem;
      color:#9ca3af;
    }
    .carousel-mini-btn{
      border:none;
      border-radius:999px;
      padding:3px 9px;
      background:#111827;
      color:#e5e7eb;
      cursor:pointer;
      font-size:0.75rem;
    }
    .carousel-indicator{
      flex:1;
      text-align:center;
      font-variant-numeric:tabular-nums;
    }

    /* ====== Resultados de b√∫squeda flotantes (siempre te siguen) ====== */
    .search-results{
      position:fixed;
      top:110px;                    /* debajo del header */
      left:50%;
      transform:translateX(-50%);
      width:min(100% - 40px, 1200px);
      max-height:180px;
      overflow-y:auto;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      padding:6px 10px;
      border-radius:12px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,.7);
      box-shadow:0 18px 30px rgba(0,0,0,.7);
      z-index:1200;                 /* por encima del carrusel y todo */
      pointer-events:auto;
    }
    .search-result-item{
      background:#111827;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.78rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(148,163,184,.6);
      cursor:pointer;
      color:#e5e7eb;
      max-width:100%;
    }
    .search-result-item span{
      max-width:190px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .search-result-play{
      font-size:0.8rem;
      opacity:.8;
    }
    .search-results-empty{
      font-size:0.78rem;
      color:#9ca3af;
      opacity:.9;
      padding:2px 0 0 2px;
      width:100%;
    }

    @media (max-width:900px){
      .carousel-row{flex-direction:column;}
      .carousel-card-img{max-height:190px;}
      .carousel-title{font-size:0.85rem;}
      .sticky-panel{top:64px;}
      #buscador{font-size:0.85rem;}
      .search-result-item span{max-width:150px;}
      .search-results{
        top:112px;
        width:calc(100% - 24px);
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <h1 class="titulo-app">
      <svg class="mano-animada" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24">
        <path d="M13.172 11H4a1 1 0 000 2h9.172l-3.586 3.586a1 1 0 101.414 1.414l5.293-5.293a1 1 0 000-1.414l-5.293-5.293a1 1 0 00-1.414 1.414L13.172 11z"/>
      </svg>
      Mi TV Station
    </h1>

    <div class="size-toolbar">
      <button class="size-btn" data-size="s">S</button>
      <button class="size-btn" data-size="m">M</button>
      <button class="size-btn" data-size="l">L</button>
      <button class="size-btn" data-size="xl">XL</button>
      <div id="openMenuBtn" onclick="toggleMenu()" title="Men√∫" style="margin-left:8px;font-size:28px;cursor:pointer;color:#00ffd5">&#9776;</div>
    </div>
  </header>

  <div class="container">
    <!-- Men√∫ lateral -->
    <div id="menuSlider">
      <h3>MENU</h3>
      <button class="menu-item" onclick="toggleSubMenu('favorites')">Favoritos</button>
      <div id="submenu-favorites" class="submenu">
        <button class="submenu-button" onclick="showFavorites()">Ver Favoritos</button>
      </div>

      <button class="menu-item" onclick="toggleSubMenu('channels')">Canales</button>
      <div id="submenu-channels" class="submenu">
        <div id="category-list"></div>
      </div>

      <button class="menu-item" onclick="toggleSubMenu('settings')">Configuraciones</button>
      <div id="submenu-settings" class="submenu">
        <button class="submenu-button" onclick="regenerarCanalesInternos()">Regenerar Canales VOD Internos</button>
        <button class="submenu-button" onclick="verCanalesInternos()">Ver Canales Internos</button>

        <label class="submenu-button" style="display:flex;gap:8px;align-items:center;cursor:pointer;">
          <input type="checkbox" id="askEveryTimeToggle" />
          <span>Siempre preguntar antes de abrir en ventana emergente</span>
        </label>

        <button class="submenu-button" onclick="resetExternPrefs()">Borrar preferencias de ventana emergente</button>
      </div>
    </div>

    <!-- Contenido principal -->
    <div>
      <input type="file" id="fileInput" accept=".json,.m3u">

      <!-- PANEL STICKY: buscador + carrusel -->
      <div class="sticky-panel">
        <div class="sticky-panel-header">
          <div>
            <p class="sticky-panel-title">Explorar series y canales</p>
            <p class="sticky-panel-sub">Busca un nombre o deja que el carrusel sugiera S1 ¬∑ Cap 1 y canales clave.</p>
          </div>
          <input type="text" id="buscador" placeholder="üîç Buscar canal o serie..." oninput="filtrarCanales()">
        </div>

        <div id="hero-carousel" class="carousel-hero"></div>
      </div>

      <!-- Resultados flotantes (se llenan con JS) -->
      <div id="search-results" class="search-results"></div>

      <div>
        <label for="channel-select">Canales:</label>
        <select id="channel-select" onchange="playSelectedChannel()"></select>
        <img id="channel-logo" style="width:100px;height:auto;margin-top:10px;border-radius:8px;display:none" />
        <button onclick="addToFavorites()">Agregar a Favoritos</button>
        <button onclick="showFavorites()">Ver Favoritos</button>
      </div>

      <!-- IFRAME -->
      <div class="player-wrap">
        <iframe id="iframePlayer" class="player-media" style="display:none;"
                allow="autoplay; fullscreen; picture-in-picture; encrypted-media"
                referrerpolicy="no-referrer" loading="lazy"></iframe>
      </div>

      <!-- Acciones iframe -->
      <div id="iframeActions" style="display:none;text-align:center;margin-top:10px;">
        <button id="openExternBtn" style="padding:10px 14px;border:none;border-radius:8px;background:#00ffd5;color:#000;font-weight:bold;cursor:pointer;">
          üîó Abrir en pesta√±a nueva
        </button>
        <div id="iframeBlockedNote" style="margin-top:8px;color:#aaa;font-size:13px;display:none;">
          ‚ö†Ô∏è Este sitio podr√≠a bloquear el embebido en iframe. Usa el bot√≥n para abrirlo aparte.
        </div>
        <div id="externPrefsRow" style="margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center;">
          <label style="display:flex;gap:8px;align-items:center;cursor:pointer;">
            <input type="checkbox" id="alwaysExternToggle" />
            <span>Siempre abrir de este dominio <strong id="domainName" style="opacity:.8;"></strong></span>
          </label>
        </div>
      </div>

      <!-- Video principal -->
      <div class="player-wrap">
        <video id="videoPlayer" class="player-media" controls autoplay muted playsinline
               poster="https://via.placeholder.com/1280x720?text=Cargando+video">
          Tu navegador no soporta la reproducci√≥n de video en vivo.
        </video>
      </div>

      <h3>üì° Canales precargados desde update.m3u:</h3>
      <div id="contenedor-autocanales" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;"></div>
      <div id="favorites-slider"></div>
      <div class="favorite-star" onclick="addToFavorites()">‚òÖ</div>
    </div>
  </div>

  <script>
    /* === TODO EL JS ES EL MISMO QUE YA TE FUNCIONABA ===
       Solo lo dejo igual que en tu √∫ltima versi√≥n buena.
       (No toqu√© nada de l√≥gica, solo se reubic√≥ el div de resultados
       y se cambi√≥ el CSS para que sea fixed) */

    (function setupSizeSelector(){
      const saved = localStorage.getItem('playerSize') || 'l';
      document.documentElement.classList.add('size-' + saved);
      const btns = [];
      document.querySelectorAll('.size-btn').forEach(function(b){
        btns.push(b);
        if(b.dataset.size === saved) b.classList.add('active');
        b.addEventListener('click', function(){
          const sz = b.dataset.size;
          document.documentElement.classList.remove('size-s','size-m','size-l','size-xl');
          document.documentElement.classList.add('size-' + sz);
          localStorage.setItem('playerSize', sz);
          btns.forEach(function(x){ x.classList.toggle('active', x===b); });
        });
      });
    })();

    let favorites = [];
    let categories = {};
    let internalDatabase = [];
    let channelsData = [];

    let carouselList = [];
    let carouselIndex = 0;
    let carouselInterval = null;
    let carouselIsPlaying = true;

    function toggleMenu(){
      document.getElementById('menuSlider').classList.toggle('open');
    }

    function normalizeCategory(title){
      if(!title) return "sin_categoria";
      return title.trim().toLowerCase().split(" ")[0];
    }
    function isHls(url){ return /\.m3u8(\?|#|$)/i.test(url); }
    function isDirectMedia(url){ return /\.(mp4|m4v|mov|webm|ogg)(\?|#|$)/i.test(url); }
    function isHttpPage(url){
      try{
        var u=new URL(url);
        return (u.protocol === 'http:' || u.protocol === 'https:') && !isHls(url) && !isDirectMedia(url);
      }catch(e){ return false; }
    }

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    function isFirstEpisodeOrNonEpisode(title){
      var t = String(title || '').toLowerCase();

      var hasMarkers =
        /temporada|season|\bs[0-9]{1,2}\b|\bt[0-9]{1,2}\b|episodio|cap[i√≠]tulo|\bep\b|\bs[0-9]{1,2}e[0-9]{1,2}\b/.test(t);

      var sxe = t.match(/s0*([0-9]{1,2})\s*e0*([0-9]{1,2})/);
      if(sxe){
        var s = parseInt(sxe[1],10);
        var e = parseInt(sxe[2],10);
        if(s === 1 && e === 1) return true;
      }

      var isSeason1 = /temporada\s*1|season\s*1|\bt1\b|\bs1\b/.test(t);
      var isEpisode1 = /episodio\s*1|cap[i√≠]tulo\s*1|\bcap\s*1\b|\bep\s*1\b|\be01\b/.test(t);

      if(isSeason1 && isEpisode1) return true;

      if(
        isSeason1 &&
        !/episodio\s*[2-9]|cap[i√≠]tulo\s*[2-9]|\bep\s*[2-9]\b|\bs0*1e0*[2-9]/.test(t)
      ){
        return true;
      }

      if(hasMarkers) return false;
      return true;
    }

    let externPrefs = {};
    try{
      externPrefs = JSON.parse(localStorage.getItem('externDomainPrefs') || '{}') || {};
    }catch(e){
      externPrefs = {};
    }

    function getHost(url){
      try{ return new URL(url).host; }catch(e){ return ''; }
    }
    function shouldOpenExtern(host){ return !!externPrefs[host]; }
    function setHostPreference(host,val){
      if(!host) return;
      if(val) externPrefs[host]=true; else delete externPrefs[host];
      localStorage.setItem('externDomainPrefs', JSON.stringify(externPrefs));
    }

    let alwaysAskExtern = true;
    try{
      var rawAsk = localStorage.getItem('alwaysAskExtern');
      if(rawAsk !== null) alwaysAskExtern = JSON.parse(rawAsk);
    }catch(e){
      alwaysAskExtern = true;
    }

    function setAlwaysAskExtern(val){
      alwaysAskExtern = !!val;
      localStorage.setItem('alwaysAskExtern', JSON.stringify(alwaysAskExtern));
    }

    function resetExternPrefs(){
      externPrefs = {};
      localStorage.removeItem('externDomainPrefs');
      alert('‚úÖ Preferencias de ventana emergente borradas. Volver√° a preguntar por cada dominio.');
    }

    function initAskEveryTimeUI(){
      var t = document.getElementById('askEveryTimeToggle');
      if(!t) return;
      t.checked = !!alwaysAskExtern;
      t.onchange = function(e){ setAlwaysAskExtern(e.target.checked); };
    }

    function setOpenExtern(url, show, blocked){
      var box=document.getElementById('iframeActions');
      var btn=document.getElementById('openExternBtn');
      var note=document.getElementById('iframeBlockedNote');
      if(!box||!btn||!note) return;
      if(show){
        box.style.display='block';
        btn.onclick=function(){ window.open(url,'_blank','noopener,noreferrer'); };
        note.style.display=blocked?'block':'none';
      }else{
        box.style.display='none';
        note.style.display='none';
        btn.onclick=null;
      }
    }

    function setupExternUIFor(url, blocked){
      if(blocked === undefined) blocked = false;
      var host=getHost(url);
      var toggle=document.getElementById('alwaysExternToggle');
      var labelDomain=document.getElementById('domainName');
      if(labelDomain) labelDomain.textContent = host ? '(' + host + ')' : '';
      if(toggle){
        toggle.checked=shouldOpenExtern(host);
        toggle.onchange=function(e){ setHostPreference(host,e.target.checked); };
      }
      setOpenExtern(url,true,blocked);
    }

    function parseM3U(content){
      var lines = content.split('\n');
      var channels = [];
      var currentTitle = '';
      var currentLogo = '';

      lines.forEach(function(line,i){
        line=line.trim();
        if(line.startsWith('#EXTINF')){
          var titleMatch=line.match(/,(.*)$/);
          currentTitle=titleMatch?titleMatch[1].trim():'Canal ' + i;
          var logoMatch=line.match(/tvg-logo="(.*?)"/i);
          currentLogo=logoMatch?logoMatch[1]:'';
        }else if(line && !line.startsWith('#')){
          channels.push({
            title: currentTitle || ('Canal ' + (channels.length+1)),
            url: line,
            thumbnail: currentLogo
          });
          currentTitle='';
          currentLogo='';
        }
      });
      return channels;
    }

    function shuffleArray(arr){
      for(var i = arr.length - 1; i > 0; i--){
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
      }
      return arr;
    }

    function setupCarousel(){
      var box = document.getElementById('hero-carousel');
      if(!box) return;

      carouselList = channelsData.filter(function(ch){ return isFirstEpisodeOrNonEpisode(ch.title); });
      if(carouselList.length === 0){
        carouselList = channelsData.slice();
      }

      if(carouselList.length === 0){
        box.innerHTML = '<p style="text-align:center;color:#aaa;margin:4px 0;">Carga una lista para ver el carrusel ‚ú®</p>';
        stopCarouselAuto();
        return;
      }

      shuffleArray(carouselList);
      carouselIndex = 0;
      renderCarouselSlide();
      startCarouselAuto();
    }

    function renderCarouselSlide(){
      var box = document.getElementById('hero-carousel');
      if(!box || carouselList.length === 0) return;

      var visible = Math.min(3, carouselList.length);
      var cardsHtml = '';
      var i, idx, ch, thumb, cat;

      for(i=0; i<visible; i++){
        idx = (carouselIndex + i) % carouselList.length;
        ch = carouselList[idx];
        thumb = ch.thumbnail || ('https://via.placeholder.com/480x270?text=' + encodeURIComponent(ch.title));
        cat = ch.category || normalizeCategory(ch.title);

        cardsHtml +=
          '<div class="carousel-card">' +
            '<div class="carousel-card-imgwrap">' +
              '<img src="' + thumb + '" alt="' + escapeHtml(ch.title) + '" class="carousel-card-img">' +
            '</div>' +
            '<div class="carousel-tag">Serie / Canal sugerido</div>' +
            '<h2 class="carousel-title">' + escapeHtml(ch.title) + '</h2>' +
            '<p class="carousel-meta">Categor√≠a: <strong>' + escapeHtml(cat) + '</strong></p>' +
            '<div class="carousel-actions">' +
              '<button class="carousel-btn primary" onclick="playFromCarousel(' + idx + ')">‚ñ∂ Reproducir</button>' +
              '<button class="carousel-btn secondary" onclick="addToFavoritesFromCarousel(' + idx + ')">‚òÖ Favorito</button>' +
            '</div>' +
          '</div>';
      }

      box.innerHTML =
        '<div class="carousel-row">' +
          cardsHtml +
        '</div>' +
        '<div class="carousel-controls">' +
          '<button class="carousel-mini-btn" onclick="prevCarousel()">‚óÄ</button>' +
          '<span class="carousel-indicator">' + (carouselIndex + 1) + ' / ' + carouselList.length + '</span>' +
          '<button class="carousel-mini-btn" onclick="nextCarousel()">‚ñ∂</button>' +
          '<button class="carousel-mini-btn" onclick="toggleCarouselAuto()">' +
            (carouselIsPlaying ? '‚è∏ Auto' : '‚ñ∂ Auto') +
          '</button>' +
        '</div>';
    }

    function startCarouselAuto(){
      stopCarouselAuto();
      if(carouselList.length <= 1) return;
      carouselIsPlaying = true;
      carouselInterval = setInterval(function(){
        carouselIndex = (carouselIndex + 1) % carouselList.length;
        renderCarouselSlide();
      }, 10000);
    }

    function stopCarouselAuto(){
      if(carouselInterval){
        clearInterval(carouselInterval);
        carouselInterval = null;
      }
    }

    function nextCarousel(){
      if(carouselList.length === 0) return;
      carouselIndex = (carouselIndex + 1) % carouselList.length;
      renderCarouselSlide();
      if(carouselIsPlaying) startCarouselAuto();
    }

    function prevCarousel(){
      if(carouselList.length === 0) return;
      carouselIndex = (carouselIndex - 1 + carouselList.length) % carouselList.length;
      renderCarouselSlide();
      if(carouselIsPlaying) startCarouselAuto();
    }

    function toggleCarouselAuto(){
      carouselIsPlaying = !carouselIsPlaying;
      if(carouselIsPlaying) startCarouselAuto();
      else stopCarouselAuto();
      renderCarouselSlide();
    }

    function playFromCarousel(idx){
      var ch = carouselList[idx];
      if(ch && ch.url) playChannel(ch.url);
    }

    function addToFavoritesFromCarousel(idx){
      var ch = carouselList[idx];
      if(!ch) return;
      if(!ch.thumbnail){
        ch.thumbnail = 'https://via.placeholder.com/320x180?text=' + encodeURIComponent(ch.title);
      }
      favorites.push(ch);
      alert('Agregado a favoritos: ' + ch.title);
    }

    function loadChannels(){
      categories = {};
      channelsData.forEach(function(channel,index){
        var title = channel.title || channel.name || channel.nombre || ('Canal ' + (index+1));
        channel.title = title.trim();
        if(!channel.thumbnail){
          channel.thumbnail = 'https://via.placeholder.com/320x180?text=' + encodeURIComponent(channel.title);
        }
        var category = normalizeCategory(channel.title);
        channel.category = category;
        if(!categories[category]) categories[category]=[];
        categories[category].push(channel);
      });
      renderCategories();
      loadChannelDropdown();
      renderAutoCargados();
      setupCarousel();
      filtrarCanales();
    }

    function renderCategories(){
      var categoryList = document.getElementById('category-list');
      categoryList.innerHTML = '';

      for (var category in categories) {
        if(!categories.hasOwnProperty(category)) continue;
        var items = categories[category];
        if (!items || items.length === 0) continue;

        var wrapper = document.createElement('div');
        wrapper.className = 'category-item';

        var btn = document.createElement('button');
        btn.className = 'submenu-button';
        btn.textContent = category + ' (' + items.length + ' canal(es))';
        btn.addEventListener('click', (function(cat){
          return function(){ toggleSubMenu(cat); };
        })(category));

        var submenu = document.createElement('div');
        submenu.id = 'submenu-' + category;
        submenu.className = 'submenu';

        items.forEach(function(ch){
          var row = document.createElement('div');
          row.style.cssText = 'display:flex;align-items:center;margin-bottom:10px;';

          var img = document.createElement('img');
          var thumb = ch.thumbnail || ('https://via.placeholder.com/100x60?text=' + encodeURIComponent(ch.title));
          img.src = thumb;
          img.alt = ch.title || '';
          img.style.cssText = 'width:60px;height:40px;object-fit:contain;margin-right:8px;border-radius:4px;';

          var right = document.createElement('div');
          right.style.flexGrow = '1';

          var playBtn = document.createElement('button');
          playBtn.textContent = '‚ñ∂ ' + ch.title;
          playBtn.style.cssText = 'margin-bottom:5px;font-size:14px;';
          playBtn.addEventListener('click', function(){
            playChannel(ch.url);
          });

          var br = document.createElement('br');

          var fav = document.createElement('button');
          fav.textContent = '+ Favorito';
          fav.style.cssText = 'font-size:12px;';
          fav.addEventListener('click', function(){
            addToFavoritesFromSubMenu(ch.title, ch.url);
          });

          right.appendChild(playBtn);
          right.appendChild(br);
          right.appendChild(fav);

          row.appendChild(img);
          row.appendChild(right);
          submenu.appendChild(row);
        });

        wrapper.appendChild(btn);
        wrapper.appendChild(submenu);
        categoryList.appendChild(wrapper);
      }
    }

    function toggleSubMenu(id){
      var el=document.getElementById('submenu-' + id);
      if(!el) return;
      el.style.display = (el.style.display==='block' ? 'none' : 'block');
    }

    function loadChannelDropdown(){
      var sel=document.getElementById('channel-select');
      var logo=document.getElementById('channel-logo');
      sel.innerHTML='';
      channelsData.forEach(function(ch,i){
        var opt=document.createElement('option');
        opt.value=i;
        opt.textContent=ch.title;
        sel.appendChild(opt);
      });
      if(channelsData[0] && channelsData[0].thumbnail){
        logo.src=channelsData[0].thumbnail;
        logo.style.display='block';
      } else {
        logo.style.display='none';
      }
    }

    function renderAutoCargados(){
      var cont=document.getElementById('contenedor-autocanales');
      cont.innerHTML='';
      channelsData.forEach(function(ch){
        var card=document.createElement('div');
        card.style.cssText='width:180px;background:#2a2a2a;border-radius:12px;padding:10px;text-align:center;box-shadow:0 4px 10px rgba(0,255,213,.2)';
        var img=document.createElement('img');
        img.src= ch.thumbnail || ('https://via.placeholder.com/320x180?text=' + encodeURIComponent(ch.title));
        img.style.cssText='width:100%;border-radius:8px;margin-bottom:8px';
        var name=document.createElement('div');
        name.textContent=ch.title;
        name.style.cssText='color:#fff;font-size:14px;margin-bottom:5px';
        var btn=document.createElement('button');
        btn.textContent='‚ñ∂Ô∏è Play';
        btn.style.cssText='background:#00ffd5;color:#000;border:none;padding:5px 10px;border-radius:6px;cursor:pointer';
        btn.onclick=function(){ playChannel(ch.url); };
        card.appendChild(img);
        card.appendChild(name);
        card.appendChild(btn);
        cont.appendChild(card);
      });
    }

    function addToFavorites(){
      var sel = document.getElementById('channel-select');
      var idx = sel.value;
      if(idx !== ''){
        var ch = channelsData[parseInt(idx,10)];
        if(!ch) return;
        if(!ch.thumbnail) ch.thumbnail='https://via.placeholder.com/320x180?text=' + encodeURIComponent(ch.title);
        favorites.push(ch);
        alert('Agregado a favoritos: ' + ch.title);
      }
    }

    function addToFavoritesFromSubMenu(title,url){
      var ch = channelsData.find(function(c){ return c.title===title && c.url===url; });
      if(ch){
        if(!ch.thumbnail) ch.thumbnail='https://via.placeholder.com/320x180?text=' + encodeURIComponent(ch.title);
        favorites.push(ch);
        alert('Agregado a favoritos: ' + ch.title);
      }
    }

    function showFavorites(){
      var slider=document.getElementById('favorites-slider');
      slider.innerHTML='';
      favorites.forEach(function(ch){
        var card=document.createElement('div');
        card.className='favorite-item';

        var preview=document.createElement('div');
        preview.style.width='320px';
        preview.style.height='180px';
        preview.style.borderRadius='10px';
        preview.style.overflow='hidden';
        preview.style.display='flex';
        preview.style.justifyContent='center';
        preview.style.alignItems='center';
        preview.style.background='#000';

        if(ch.thumbnail){
          var img=document.createElement('img');
          img.src=ch.thumbnail;
          img.alt=ch.title;
          img.style.maxWidth='100%';
          img.style.maxHeight='100%';
          img.style.objectFit='contain';
          img.style.borderRadius='10px';
          preview.appendChild(img);
        }else{
          preview.style.background='linear-gradient(135deg,#00ffd5,#0f0f0f)';
          preview.style.color='#000';
          preview.style.fontWeight='bold';
          preview.style.fontSize='18px';
          preview.style.animation='pulse 2s infinite';
          preview.textContent=ch.title;
        }

        var name=document.createElement('div');
        name.className='channel-name';
        name.textContent=ch.title;

        var hover=document.createElement('div');
        hover.className='hover-content';
        var playBtn=document.createElement('button');
        playBtn.textContent='‚ñ∂ Play';
        playBtn.addEventListener('click',function(){
          playChannel(ch.url);
        });
        hover.appendChild(playBtn);

        card.appendChild(preview);
        card.appendChild(name);
        card.appendChild(hover);
        slider.appendChild(card);
      });
    }

    function playChannel(url){
      var video=document.getElementById('videoPlayer');
      var iframe=document.getElementById('iframePlayer');

      if(window.hls){
        try{window.hls.destroy();}catch(e){}
        window.hls=null;
      }

      if(isHls(url)){
        iframe.style.display='none';
        iframe.src='about:blank';
        setOpenExtern(url,false);
        if(Hls.isSupported()){
          var hls=new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          window.hls=hls;
        } else if(video.canPlayType('application/vnd.apple.mpegurl')){
          video.src=url;
        } else {
          alert('Este navegador no soporta HLS');
        }
        video.style.display='block';
        video.play().catch(function(){});
        return;
      }

      if(isDirectMedia(url)){
        iframe.style.display='none';
        iframe.src='about:blank';
        setOpenExtern(url,false);
        video.src=url;
        video.style.display='block';
        video.play().catch(function(){});
        return;
      }

      if(isHttpPage(url)){
        var host = getHost(url);

        if(shouldOpenExtern(host) && alwaysAskExtern){
          var resp = confirm(
            'Este dominio (' + host + ') est√° marcado para abrir SIEMPRE en ventana emergente.\n\n' +
            '¬øQuieres abrir en ventana emergente esta vez?\n\n' +
            'Aceptar = Abrir emergente\nCancelar = Intentar abrir aqu√≠ (iframe)'
          );
          if(resp){
            window.open(url,'_blank','noopener,noreferrer');
            iframe.style.display='none';
            iframe.src='about:blank';
            setOpenExtern(url,false);
            video.pause();
            video.style.display='none';
            video.removeAttribute('src');
            return;
          }
        } else if(shouldOpenExtern(host) && !alwaysAskExtern){
          window.open(url,'_blank','noopener,noreferrer');
          iframe.style.display='none';
          iframe.src='about:blank';
          setOpenExtern(url,false);
          video.pause();
          video.style.display='none';
          video.removeAttribute('src');
          return;
        }

        video.pause();
        video.style.display='none';
        video.removeAttribute('src');
        iframe.style.display='block';
        iframe.src=url;
        setupExternUIFor(url,false);

        setTimeout(function(){
          var blocked=false;
          try{
            var doc=iframe.contentDocument;
            blocked=!doc;
          }catch(e){
            blocked=true;
          }
          if(blocked){
            setupExternUIFor(url,true);
            if(!shouldOpenExtern(host)){
              var ok = confirm(
                'Parece que ' + host + ' bloquea el iframe.\n' +
                '¬øQuieres abrir SIEMPRE este dominio en pesta√±a nueva a partir de ahora?'
              );
              if(ok){
                setHostPreference(host,true);
                window.open(url,'_blank','noopener,noreferrer');
              }
            }
          }
        },1200);
        return;
      }

      alert('Tipo de enlace no reconocido. Abriendo en nueva pesta√±a‚Ä¶');
      window.open(url,'_blank','noopener,noreferrer');
    }

    function playSelectedChannel(){
      var sel=document.getElementById('channel-select');
      var idx=sel.value;
      var logo=document.getElementById('channel-logo');
      if(idx === '') return;
      var ch=channelsData[parseInt(idx,10)];
      if(ch && ch.url){
        playChannel(ch.url);
        if(ch.thumbnail){
          logo.src=ch.thumbnail;
          logo.style.display='block';
        } else {
          logo.style.display='none';
        }
      }
    }

    function filtrarCanales(){
      var buscador = document.getElementById('buscador');
      var q = buscador ? buscador.value.toLowerCase() : '';
      var sel = document.getElementById('channel-select');
      var resultsBox = document.getElementById('search-results');

      sel.innerHTML = '';
      if(resultsBox) resultsBox.innerHTML = '';

      var matches = [];

      channelsData.forEach(function(ch,i){
        if(ch.title.toLowerCase().includes(q)){
          var opt=document.createElement('option');
          opt.value=i;
          opt.textContent=ch.title;
          sel.appendChild(opt);
          matches.push({ ch: ch, index: i });
        }
      });

      if(resultsBox){
        if(!q){
          return;
        }
        if(matches.length === 0){
          var empty = document.createElement('div');
          empty.className = 'search-results-empty';
          empty.textContent = 'Sin resultados para esta b√∫squeda.';
          resultsBox.appendChild(empty);
          return;
        }

        var maxToShow = 20;
        for(var j=0; j<matches.length && j<maxToShow; j++){
          var m = matches[j];
          var item = document.createElement('div');
          item.className = 'search-result-item';

          var playSpan = document.createElement('span');
          playSpan.className = 'search-result-play';
          playSpan.textContent = '‚ñ∂';

          var titleSpan = document.createElement('span');
          titleSpan.textContent = m.ch.title;

          item.appendChild(playSpan);
          item.appendChild(titleSpan);
          item.addEventListener('click',(function(idxLocal){
            return function(){
              sel.value = String(idxLocal);
              var chLocal = channelsData[idxLocal];
              if(chLocal) playChannel(chLocal.url);
            };
          })(m.index));

          resultsBox.appendChild(item);
        }

        if(matches.length > maxToShow){
          var extra = document.createElement('div');
          extra.className = 'search-results-empty';
          extra.textContent = '+' + (matches.length - maxToShow) + ' resultados m√°s‚Ä¶ usa el listado de canales.';
          resultsBox.appendChild(extra);
        }
      }
    }

    document.getElementById('fileInput').addEventListener('change',function(e){
      var file=e.target.files[0];
      if(!file) return;
      var reader=new FileReader();
      reader.onload=function(ev){
        var content=ev.target.result.trim();
        var name=file.name.toLowerCase();

        if(name.endsWith('.json')){
          try{
            var parsed=JSON.parse(content);
            if(Array.isArray(parsed)) channelsData=parsed;
            else if(parsed.channels && Array.isArray(parsed.channels)) channelsData=parsed.channels;
            else if(parsed.lista && Array.isArray(parsed.lista)) channelsData=parsed.lista;
            else {
              alert('Formato de JSON no reconocido.');
              return;
            }
            console.log('‚úÖ JSON cargado:',channelsData);
            loadChannels();
          }catch(err){
            alert('‚ùå Error al leer el archivo JSON');
          }
        }else if(name.endsWith('.m3u')){
          try{
            channelsData=parseM3U(content);
            console.log('‚úÖ M3U cargado:',channelsData);
            loadChannels();
          }catch(err){
            alert('‚ùå Error al procesar el archivo M3U');
          }
        }else{
          alert('‚ùå Tipo de archivo no soportado. Usa .json o .m3u');
        }
      };
      reader.readAsText(file);
    });

    function regenerarCanalesInternos(){
      if(!confirm('¬øEst√°s seguro que deseas borrar y regenerar los 1000 canales internos?')) return;
      var generated=[];
      for(var i=0;i<1000;i++){
        generated.push({
          name:'Canal ' + (i+1),
          title:'VOD Canal ' + (i+1),
          url:'https://vod.mycamtv.net/' + (i+1) + '.m3u8',
          category:'VOD Categoria ' + ((i%10)+1),
          thumbnail:'https://via.placeholder.com/320x180?text=VOD+' + (i+1)
        });
      }
      localStorage.setItem('internalDatabase', JSON.stringify(generated));
      internalDatabase=generated;
      channelsData=generated.slice();
      loadChannels();
      alert('‚úÖ Canales VOD regenerados.');
    }

    function verCanalesInternos(){
      if(!internalDatabase || internalDatabase.length===0){
        alert('‚ö† No hay canales internos cargados. Primero reg√©n√©ralos.');
        return;
      }
      channelsData=internalDatabase.slice();
      loadChannels();
      alert('‚úÖ Mostrando canales internos VOD.');
    }

    window.addEventListener('DOMContentLoaded',function(){
      initAskEveryTimeUI();
      fetch('update3.m3u')
        .then(function(res){ return res.text(); })
        .then(function(text){
          if(text.indexOf('#EXTM3U') !== -1){
            channelsData=parseM3U(text);
            console.log('üîç Canales detectados:',channelsData);
            loadChannels();
          }else{
            console.warn('‚ö† El archivo no parece ser un M3U v√°lido');
          }
        })
        .catch(function(err){
          console.warn('‚ùå No se pudo cargar update3.m3u:',err);
        });
    });
  </script>
</body>
</html>
